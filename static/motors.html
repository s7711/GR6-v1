<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Motors</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.png">
  <script src="js/socket.io.min.js"></script>
  <script src="messages.js"></script>
  <script src="js/moment.min.js"></script>
  <script src="js/chart.umd.min.js"></script>
  <script src="js/chartjs-adapter-moment.min.js"></script>
</head>
  <body>
    <!-- Title: Generic Aiding -->
    <table style="width:100%;">
      <tr style="vertical-align: baseline;">
        <td><h1 style="border-bottom: none; margin: 0;"><a href="index.html" style=text-decoration:none>Motors</a></h1></td>
        <td>
        <p>Send: <input type="text" id="send_text" onkeypress="doit_onkeypress(event);"/></p>
        </td>
      </tr>
    </table>
    <table style="width:100%;">
      <tr>
        <td style="width: 50%;">
            <table style="width:100%;">
                <tr>
                    <td style="width:50%;">
                        <div class="rcorners1">
                            <p class="meas1">Left motor (counts)</p>
                            <p class="value1" id="mi_LM_position">- - -</p>
                        </div>
                    </td>
                    <td style="width:50%;">
                        <div class="rcorners1">
                            <p class="meas1">Left motor (filtered speed)</p>
                            <p class="value1" id="mf1_filtLM_vel">- - -</p>
                        </div>
                    </td>
                </tr>
            </table>
            <div class="rcorners2">
                <div class="chart-container" style="height: 400px">
                    <canvas id="chart_lm"></canvas>
                </div>
            </div>
        </td>

        <td style="width: 50%;">
            <table style="width:100%;">
                <tr>
                    <td style="width:50%;">
                        <div class="rcorners1">
                            <p class="meas1">Right motor (counts)</p>
                            <p class="value1" id="mi_RM_position">- - -</p>
                        </div>
                    </td>
                    <td style="width:50%;">
                        <div class="rcorners1">
                            <p class="meas1">Right motor (filtered speed)</p>
                            <p class="value1" id="mf1_filtRM_vel">- - -</p>
                        </div>
                    </td>
                </tr>
            </table>
            <div class="rcorners2">
                <div class="chart-container" style="height: 400px">
                    <canvas id="chart_rm"></canvas>
                </div>
            </div>
        </td>




      </tr>
    </table>
    <div class="rcorners1">    
        <p class="meas1">Water pump: <span id="mi_WaterPump">-</span></p>
        <p class="meas1">Propotional gain (Kp): <span id="mf2_LM_Kp">-</span>, <span id="mf2_RM_Kp">-</span></p>
        <p class="meas1">Integral gain (Ki): <span id="mf2_LM_Ki">-</span>, <span id="mf2_RM_Ki">-</span></p>
        <p class="meas1">Acceleration gain (Kd): <span id="mf2_LM_Kd">-</span>, <span id="mf2_RM_Kd">-</span></p>
        <p class="meas1">Feed forward gain (Kf): <span id="mf2_LM_Kf">-</span>, <span id="mf2_RM_Kf">-</span></p>
        <p class="meas1">Differential error filter (Ka): <span id="mf2_LM_Ka">-</span>, <span id="mf2_RM_Ka">-</span> (Ka = 0.0 to use raw differential error)</p>
        <p class="meas1">Velocity filter (Kb): <span id="mf2_LM_Kb">-</span>, <span id="mf2_RM_Kb">-</span> (Kb = 0.0 to use raw velocity)</p>
        <p class="meas1">Maximum integral error (Mi): <span id="mf2_LM_Mi">-</span>, <span id="mf2_RM_Mi">-</span></p>
        <p class="meas1">Minimum integral error (Mj): <span id="mf2_LM_Mj">-</span>, <span id="mf2_RM_Mj">-</span></p>
        <p class="meas1">Integral gain decay (Id): <span id="mf2_LM_Id">-</span>, <span id="mf2_RM_Id">-</span></p>
        <p class="meas1">Deadband (Db): <span id="mi_LM_Db">-</span>, <span id="mi_RM_Db">-</span></p>
        <p class="meas1">Maximum acceleration (Am): <span id="mi_LM_Am">-</span>, <span id="mi_RM_Am">-</span></p>
        <p class="meas1">Version: <span id="ms_MotorVersion">-</span></p>
    </div>

  <script defer>
    function onMotorData(data) {
        updateId(data)
        updateCharts(data)
    }

    window.addEventListener("load", function() {
      initCharts();
      startSocket('motor', onMotorData)
    });

const MAX_POINTS = 80;

// Helper to create a time series scatter chart
function createScatterChart(ctx, yMin, yMax, yLabel) {
    return new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                { label: "Set Velocity", data: [], borderColor: 'red', showLine: true, radius: 0, borderWidth: 3 },
                { label: "Filtered velocity", data: [], borderColor: 'green', showLine: true, radius: 0, borderWidth: 4 },
                { label: "Error signal", data: [], borderColor: 'blue', showLine: true, radius: 0, borderWidth: 2 },
                { label: "Integrated error", data: [], borderColor: 'orange', showLine: true, radius: 0, borderWidth: 2 },
                { label: "Differential error", data: [], borderColor: 'pink', showLine: true, radius: 0, borderWidth: 1 },
                { label: "Motor output", data: [], borderColor: 'purple', showLine: true, radius: 0, borderWidth: 3 },
            ]
        },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'second', tooltipFormat: 'HH:mm:ss' },
                    title: { display: true, text: 'Time' }
                },
                y: {
                    min: yMin,
                    max: yMax,
                    title: { display: true, text: yLabel }
                }
            },
            plugins: {
                legend: { display: true }
            }
        }
    });
}

// Call this once on page load
function initCharts() {
    const ctxLM = document.getElementById('chart_lm').getContext('2d');
    const ctxRM = document.getElementById('chart_rm').getContext('2d');
    chartLM = createScatterChart(ctxLM, -50, 200, 'Left motor');
    chartRM = createScatterChart(ctxRM, -50, 200, 'Right motor');
}

// Call this for each new nav-data point
function updateCharts(data) {
    if (!chartLM || !chartRM) return;
    const t = new Date();

    // Left motor data
    chartLM.data.datasets[0].data.push({ x: t, y: data.LM_setvel });
    chartLM.data.datasets[1].data.push({ x: t, y: data.filtLM_vel });
    chartLM.data.datasets[2].data.push({ x: t, y: data.errLM });
    chartLM.data.datasets[3].data.push({ x: t, y: data.integralLM });
    chartLM.data.datasets[4].data.push({ x: t, y: data.filtLM_acc });
    chartLM.data.datasets[5].data.push({ x: t, y: data.outLM });
    // Right motor data
    chartRM.data.datasets[0].data.push({ x: t, y: data.RM_setvel });
    chartRM.data.datasets[1].data.push({ x: t, y: data.filtRM_vel });
    chartRM.data.datasets[2].data.push({ x: t, y: data.errRM });
    chartRM.data.datasets[3].data.push({ x: t, y: data.integralRM });
    chartRM.data.datasets[4].data.push({ x: t, y: data.filtRM_acc });
    chartRM.data.datasets[5].data.push({ x: t, y: data.outRM });

    // Keep only the last MAX_POINTS
    for (let ds of chartLM.data.datasets) {
        if (ds.data.length > MAX_POINTS) ds.data.shift();
    }
    for (let ds of chartRM.data.datasets) {
        if (ds.data.length > MAX_POINTS) ds.data.shift();
    }

    chartLM.update('none');
    chartRM.update('none');
    }

    // Processes entries to the "send" box
    // which can be used to send messages or to configure some
    // parameters
    function doit_onkeypress(event) {
        const key = event.key || event.keyCode;

        if (key === 'Enter' || key === 13) {
            const urlParams = new URLSearchParams(window.location.search);
            const ip = urlParams.get('ip');

            const txt = document.getElementById("send_text").value;
            args = txt.split(" ");
            if( args[0] == "AmID" )
            AmIdFilter = parseInt(args[1])
            else
            socket.emit('user-command?ip='+ip,txt);
        }
    }

  </script>
</body>
</html>