<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Path Following</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.png">
  <script src="js/socket.io.min.js"></script>
  <script src="messages.js"></script>
  <script src="js/moment.min.js"></script>
  <script src="js/chart.umd.min.js"></script>
  <script src="js/chartjs-adapter-moment.min.js"></script>
  <script src="js/joystick.js"></script>
</head>
<body>
  <!-- Flex container for buttons -->
  <div style="margin:10px; display:flex; gap:10px; flex-wrap:wrap;">
    <button class="gadButton"
            style="flex:1; min-width:120px; width:auto;"
            onclick="togglePathMenu()">Paths</button>
    <button class="gadButton"
            style="flex:1; min-width:120px; width:auto;"
            onclick="send2mPath()">Send 2m path</button>
    <button class="gadButton"
            style="flex:1; min-width:120px; width:auto;"
            onclick="startPath()">Start following</button>
    <button class="gadButton"
            style="flex:1; min-width:120px; width:auto;"
            onclick="stopPath()">Stop following</button>
    <button class="gadButton"
            style="flex:1; min-width:120px; width:auto;"
            onclick="sendWater()">Water</button>
  </div>


  <!-- Floating menu OUTSIDE the flex container -->
  <div id="pathMenu" style="
    display: none;
    position: absolute;
    z-index: 1000;
    background-color: white;
    border: 4px solid #ca181c;
    border-radius: 10px;
    padding: 40px;
    width: 400px;
    max-height: 600px;
    overflow-y: auto;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  ">
    <select id="pathList" size="10" style="width: 100%; font-size: 20px; cursor: pointer; padding: 8px; margin-bottom: 10px;"></select>
    <button class="gadButton" style="width: 90%;" onclick="loadSelectedPath()">Load Selected</button>
  </div>

  <table style="width:100%; height:100%;">
    <tr>
      <!-- Top Left: Camera -->
      <td style="width:50%; height:50%;">
        <div id="joystick-container" style="position: relative; width: 640px; height: 480px;">
          <img src="camera.mjpg" id="camera-feed"
              style="width: 100%; height: 100%; display: block;">
          <canvas id="joystick"
                  style="position: absolute; top: 0; left: 0;"></canvas>
        </div>
      </td>
      <!-- Top Right: XY Path Chart -->
      <td style="width:50%; height:50%;">
        <div class="chart-container" style="height: 100%;">
          <canvas id="chart_xy"></canvas>
        </div>
      </td>
    </tr>
    <tr>
      <!-- Bottom Left: Control Values -->
      <td style="width:50%; height:50%;">
        <div id="control_values" class="rcorners1">
          <p class="meas1">State: <span id="mi_State">-</span></p>
          <p class="meas1">Current X: <span id="mf2_CurrentX">-</span></p>
          <p class="meas1">Current Y: <span id="mf2_CurrentY">-</span></p>
          <p class="meas1">Current heading: <span id="mf2_CurrentHeading">-</span></p>
          <p class="meas1">Position accuracy: <span id="mf2_PositionAccuracy">-</span></p>
          <p class="meas1">Position Error: <span id="mf2_PositionError">-</span></p>
          <p class="meas1">Integrated Error: <span id="mf2_IntegratedError">-</span></p>
          <p class="meas1">Ultrasonic front right: <span id="mf2_U0">-</span></p>
          <p class="meas1">Ultrasonic back right: <span id="mf2_U1">-</span></p>
          <p class="meas1">Ultrasonic back: <span id="mf2_U2">-</span></p>
          <p class="meas1">Ultrasonic back left: <span id="mf2_U3">-</span></p>
          <p class="meas1">Ultrasonic front left: <span id="mf2_U4">-</span></p>
          <p class="meas1">Path index: <span id="mi_PathIndex">-</span></p>
          <p class="meas1">Yaw Error: <span id="mf2_YawError">-</span></p>
          <p class="meas1">Forward: <span id="mf2_Forward">-</span></p>
          <p class="meas1">Turn: <span id="mf2_Turn">-</span></p>
          <p class="meas1">Left motor: <span id="mi_LeftMotor">-</span></p>
          <p class="meas1">Right motor: <span id="mi_RightMotor">-</span></p>
          <p class="meas1">Target X: <span id="mf2_TargetX">-</span></p>
          <p class="meas1">Target Y: <span id="mf2_TargetY">-</span></p>
        </div>
      </td>

      <!-- Bottom Right: Motor Charts -->
      <td style="width:50%; height:50%;">
        <div class="chart-container" style="height: 100%;">
          <canvas id="chart_motor"></canvas>
        </div>
      </td>
    </tr>
  </table>

  <script defer>
    let chartXY, chartMotor;
    let trail = [];

    const MAX_POINTS = 100;

    function initCharts() {
      // XY Chart
      const ctxXY = document.getElementById('chart_xy').getContext('2d');
      chartXY = new Chart(ctxXY, {
        type: 'scatter',
        data: {
          datasets: [
            { label: 'Path', data: [], borderColor: 'gray', showLine: true, pointRadius: 2 },
            { label: 'Trail', data: [], pointRadius: 4, pointBackgroundColor: "rgb(202,24,28)" },
            { label: 'Current', data: [], pointRadius: 16, pointStyle: "cross", borderColor: "rgb(0,0,0)", borderWidth: 2, },
            { label: 'Lookahead', data: [], backgroundColor: 'green', pointRadius: 5 },
            { label: 'Heading', data: [], borderColor: 'red', showLine: true, pointRadius: 0 },
          ]
        },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              min: -5,  // Minimum X value
              max: 5,   // Optional: fixed or dynamic
              title: { display: true, text: 'X' }
            },
            y: {
              min: -5,  // Minimum Y value
              max: 5,   // Optional: fixed or dynamic
              title: { display: true, text: 'Y' }
            }
          },
          plugins: { legend: { display: false } }
        }
      });

      // Motor Charts
      const ctxMotor = document.getElementById('chart_motor').getContext('2d');
      chartMotor = createMotorChart(ctxMotor);
    }

    function createMotorChart(ctx) {
      return new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [
            { label: "Left Set Velocity", data: [], borderColor: 'red', showLine: true, radius: 0, borderWidth: 4 },
            { label: "Left Motor output", data: [], borderColor: 'pink', showLine: true, radius: 0, borderWidth: 2 },
            { label: "Right Set Velocity", data: [], borderColor: 'blue', showLine: true, radius: 0, borderWidth: 4 },
            { label: "Right Motor output", data: [], borderColor: 'cyan', showLine: true, radius: 0, borderWidth: 2 },
          ]
        },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: { unit: 'second', tooltipFormat: 'HH:mm:ss' },
              title: { display: true, text: 'Time' }
            },
            y: {
              min: -200,
              max: 200,
              title: { display: true, text: 'Motor signals' }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    function updateXYBounds(centerX, centerY, minRange = 10) {
      const half = minRange / 2;
      chartXY.options.scales.x.min = centerX - half;
      chartXY.options.scales.x.max = centerX + half;
      chartXY.options.scales.y.min = centerY - half;
      chartXY.options.scales.y.max = centerY + half;
    }

    let latestControl = {};

    function onPathControlData(data) {
      messages_updateId(data);
      latestControl = data;  // Save for button use

      // Update trail
      trail.push({ x: data.CurrentX, y: data.CurrentY });
      if (trail.length > MAX_POINTS) trail.shift();

      chartXY.data.datasets[1].data = trail;
      chartXY.data.datasets[2].data = [{ x: data.CurrentX, y: data.CurrentY }];
      chartXY.data.datasets[3].data = [{ x: data.TargetX, y: data.TargetY }];

      const headingDeg = data.CurrentHeading;
      const headingRad = (90 - headingDeg) * Math.PI / 180;  // Convert to math-style yaw
      const arrowLength = 0.5;  // meters

      const hx = data.CurrentX + arrowLength * Math.cos(headingRad);
      const hy = data.CurrentY + arrowLength * Math.sin(headingRad);

      chartXY.data.datasets[4].data = [
        { x: data.CurrentX, y: data.CurrentY },
        { x: hx, y: hy }
      ];

      updateXYBounds(data.CurrentX, data.CurrentY);
      chartXY.update('none');
    }

    function onMotorData(data) {
      messages_updateId(data);

      // Update motor charts
      const t = new Date();
      chartMotor.data.datasets[0].data.push({ x: t, y: data.LM_setvel });
      chartMotor.data.datasets[1].data.push({ x: t, y: data.outLM });
      chartMotor.data.datasets[2].data.push({ x: t, y: data.RM_setvel });
      chartMotor.data.datasets[3].data.push({ x: t, y: data.outRM });

      if (chartMotor.data.datasets[0].data.length > MAX_POINTS) chartMotor.data.datasets[0].data.shift();
      if (chartMotor.data.datasets[1].data.length > MAX_POINTS) chartMotor.data.datasets[1].data.shift();
      if (chartMotor.data.datasets[2].data.length > MAX_POINTS) chartMotor.data.datasets[2].data.shift();
      if (chartMotor.data.datasets[3].data.length > MAX_POINTS) chartMotor.data.datasets[3].data.shift();

      chartMotor.update('none');
    }

    function onPathMapData(path) {
      chartXY.data.datasets[0].data = path.map(p => ({ x: p[0], y: p[1] }));
      chartXY.update('none');
    }

    function send2mPath() {
      const x = latestControl.CurrentX;
      const y = latestControl.CurrentY;
      const headingDeg = latestControl.CurrentHeading;

      if (x === undefined || y === undefined || headingDeg === undefined) {
        alert("Current position or heading not available.");
        return;
      }

      const headingRad = headingDeg * Math.PI / 180;
      const dx = 5.0 * Math.sin(headingRad);
      const dy = 5.0 * Math.cos(headingRad);

      const path = [
        [x, y, 0.5, 0],  // Start point with speed
        [x + dx, y + dy, 0.5, 0] 
      ];

      socket.emit('user-command', '>set-path ' + JSON.stringify(path));
    }

    function startPath() {
      socket.emit('user-command', '>start-path');
    }

    function stopPath() {
      socket.emit('user-command', '>stop-path');
    }

    function sendWater() {
      socket.emit('user-command', '&WP 1');
    }

    function togglePathMenu() {
      const menu = document.getElementById('pathMenu');
      menu.style.display = (menu.style.display === 'none') ? 'block' : 'none';
    }

    function loadSelectedPath() {
      const list = document.getElementById('pathList');
      const filename = list.value;
      if (!filename) {
        alert("Please select a path file.");
        return;
      }
      socket.emit('user-command', '>load-path ' + filename);
      document.getElementById('pathMenu').style.display = 'none';
    }

    function onPathPaths(filenames) {
      const list = document.getElementById('pathList');
      list.innerHTML = '';  // Clear existing options
      filenames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        list.appendChild(option);
      });
    }

    window.addEventListener("load", function() {
      initCharts();
      startSocket('path-control', onPathControlData);
      startSocket('path-map', onPathMapData);
      startSocket('path-paths', onPathPaths);
      startSocket('motor', onMotorData)
      initJoystick(socket);
    });
  </script>
</body>
</html>
