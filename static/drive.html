<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Drive</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="favicon.png">
  <script src="js/socket.io.min.js"></script>
  <script src="messages.js"></script>
  <script src="js/joystick.js"></script>
  <script src="js/moment.min.js"></script>
  <script src="js/chart.umd.min.js"></script>
  <script src="js/chartjs-adapter-moment.min.js"></script>
</head>
  <body>
    
    <div style="display: flex; flex-wrap: wrap; align-items: flex-start; gap: 16px;">
      <!-- Left: Camera/Joystick -->
      <div style="flex: 0 0 640px;">
        <div id="joystick-container" style="position: relative; width: 640px; height: 480px;">
          <img src="camera.mjpg" id="camera-feed"
              style="width: 100%; height: 100%; display: block;">
          <canvas id="joystick"
                  style="position: absolute; top: 0; left: 0;"></canvas>
        </div>
      </div>

      <!-- Right: Table of fields -->
      <div style="flex: 1 1 300px; min-width: 400px;">
        <div class="rcorners2">
          <p class="meas2">Map XYZ (m)</p>
          <span class="value2">(</span>
          <span class="value2" id="mf2_MapLocalX">- - -</span><span class="value2">,</span>
          <span class="value2" id="mf2_MapLocalY">- - -</span><span class="value2">,</span>
          <span class="value2" id="mf2_MapLocalZ">- - -</span><span class="value2">)</span>
        </div>

        <table style="table-layout: fixed; width: 100%;">
          <tr>
            <td><div class="rcorners2"><p class="meas2">GNSS satellites</p><p class="value2" id="mi_GpsNumObs">- - -</p></div></td>
            <td><div class="rcorners2"><p class="meas2">GNSS position mode</p><p class="value2" id="mt_GpsPosMode">- - -</p></div></td>
            <td><div class="rcorners2"><p class="meas2">GNSS velocity mode</p><p class="value2" id="mt_GpsVelMode">- - -</p></div></td>
          </tr>
        </table>
        <table style="table-layout: fixed; width: 100%;">
          <tr>
            <td><div class="rcorners2"><p class="meas2">INS Speed</p><p class="value2" id="mf1_Speed">- - -</p></div></td>
            <td><div class="rcorners2"><p class="meas2">Left wheel speed</p><p class="value2" id="mf1_GwsLeftVelocity">- - -</p></div></td>
            <td><div class="rcorners2"><p class="meas2">Right wheel speed</p><p class="value2" id="mf1_GwsRightVelocity">- - -</p></div></td>
          </tr>
        </table>
      </div>
    </div>

    <div class="chart-container" style="height: 480px;">
      <canvas id="chart_motor"></canvas>
    </div>

<script defer>
  const MAX_POINTS = 120;
  let InsSpeed = 0.0;

  function onMotorData(data) {
    updateId(data)
  }
  function onNavData(data) {
    InsSpeed = Math.sqrt(data.Vn**2 + data.Ve**2);
    data.Speed = InsSpeed;
    updateId(data)
  }
  function onStatusData(data) {
    updateId(data)
  }
  function onWheelspeedData(data) {
    updateId(data)

    // Update charts
    const t = new Date();
    chartMotor.data.datasets[0].data.push({ x: t, y: data.GwsLeftVelocity });
    chartMotor.data.datasets[1].data.push({ x: t, y: data.GwsRightVelocity });
    chartMotor.data.datasets[2].data.push({ x: t, y: InsSpeed });

    if (chartMotor.data.datasets[0].data.length > MAX_POINTS) chartMotor.data.datasets[0].data.shift();
    if (chartMotor.data.datasets[1].data.length > MAX_POINTS) chartMotor.data.datasets[1].data.shift();
    if (chartMotor.data.datasets[2].data.length > MAX_POINTS) chartMotor.data.datasets[2].data.shift();

    chartMotor.update('none');
  }

  window.addEventListener("load", function() {
    startSocket('motor', onMotorData);
    startSocket('nav-data-192.168.196.147', onNavData); // TODO: sort out IP address
    startSocket('nav-status-192.168.196.147', onStatusData); // TODO: sort out IP address
    startSocket('gad_wheelspeed', onWheelspeedData);
    initJoystick(socket);

    const ctxMotor = document.getElementById('chart_motor').getContext('2d');
    chartMotor = createMotorChart(ctxMotor);
  });


  function createMotorChart(ctx) {
    return new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [
          { label: "Left Velocity", data: [], borderColor: 'red', showLine: true, radius: 0, borderWidth: 2 },
          { label: "Right  Velocity", data: [], borderColor: 'blue', showLine: true, radius: 0, borderWidth: 2 },
          { label: "INS Speed", data: [], borderColor: 'green', showLine: true, radius: 0, borderWidth: 4 },
        ]
      },
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'time',
            time: { unit: 'second', tooltipFormat: 'HH:mm:ss' },
            title: { display: true, text: 'Time' }
          },
          y: {
            suggestedMin: -1,
            suggestedMax: 1,
            title: { display: true, text: 'Motor signals' }
          }
        },
      }
    });
  }


  </script>
</body>
</html>